(function(e,t,n){n.classes.SendMessage=function(r){var i,s,o,u,a=n.classes.colorutil;i=t.extend({app:null,is_mobile:!1,$e:null,selector:"",$trigger:null,color_picker_src:"",bg_desaturation:.6,prompts:t.isArray(n.classes.prompts)?n.classes.prompts:[],service_dir:""},r);s={name:"mod.SendMessage",$e:i.$e?i.$e:t(i.selector),$trigger:i.$trigger,is_mobile:i.is_mobile,is_touch:null,overlay:null,merlin:null,colorpicker:null,prompts:i.prompts};o={init:function(){s.is_touch="ontouchstart"in e||e.DocumentTouch&&document instanceof DocumentTouch;s.overlay=new NI.Overlay({flavor:"merlin-overlay",autoflush:!1,closeBtn:!0,isTouchDevice:s.is_touch,onOpen:function(){i.app.events.trigger("overlay:opened")},onClose:function(){i.app.events.trigger("overlay:closed")}});s.overlay.setBody(s.$e.detach());s.$trigger.click(u.trigger_click);t.isArray(s.prompts)||console.warn("Missing prompts for messages")},set_random_prompt:function(){var e=NI.fn.randomElement(s.prompts);s.merlin.internal.steps.compose.fields.m.component.set_val(e)},get_bg_css:function(e,t,n){var r;r=a.rgbToHSV(e,t,n);r.s=r.s*i.bg_desaturation;return a.rgbToString(a.hsvToRGB(r))}};u={trigger_click:function(e,t){e.preventDefault();s.is_touch||s.overlay.open()},load_prompt_click:function(e,t){e.preventDefault();o.set_random_prompt()},color_picked:function(e,t){var n,r,i,u;n=s.merlin;r=t.r;i=t.g;u=t.b;n.set_val("r",r);n.set_val("g",i);n.set_val("b",u);e.data.container.css({"background-color":o.get_bg_css(r,i,u)})}};s.merlin=new NI.Merlin({name:s.name+" Merlin",$e:s.$e,controls:{prev:".prev",next:".next"},extensions:{data:new NI.MerlinData({uri:i.service_dir+"add.php",data:{m:"",r:null,g:null,b:null}})},first_step:"info",steps:{info:{selector:".send-message-info",next:"compose"},compose:{selector:".send-message-compose",next:s.is_mobile?"geo":"dispatch",fields:{m:{selector:"textarea[name=m]",options:{extensions:{Validator:{validators:["required","maxlen=100"]},Counter:{max:100}},handlers:{focus:function(e){var t,n;t=e.data.me;n=t.get_val();n.substring(n.length-3)==="..."&&t.set_val(n.substring(0,n.length-3)+" ")}}}}},init:function(e){var r=e.internal.current_step,o=r.$e.find(".color-picker");e.extensions.data.init(e);s.is_touch?o.on("color:picked",{container:t("body")},u.color_picked):o.on("color:picked",{container:r.$e},u.color_picked);s.colorpicker=new n.classes.ColorPicker({$e:o,src:i.color_picker_src});r.$e.find(".load-prompt").on("click",u.load_prompt_click)},visible:function(e){s.colorpicker.reset();o.set_random_prompt();s.is_touch&&t("html, body").animate({scrollTop:0},"slow")},finish:function(e){e.extensions.data.collect_fields(e)}},geo:{selector:".send-message-geo",prev:"compose",next:"dispatch",init:function(e){}},dispatch:{selector:".step.dispatch",visible:function(e){e.extensions.data.post_data(function(t){e.show_step("thank-you")})}},"thank-you":{selector:".step.thank-you",visible:function(t){e.setTimeout(function(){s.overlay.close();s.is_touch?location.reload():t.show_step("compose")},3e3)}}}});o.init();console.log(s)}})(this,this.jQuery,this.page);